# C++ Architecture for tstse

This document explains the organization of C++ source files in `src/`.

## File Naming Convention

Files are prefixed by category:

| Prefix | Category | Description |
|--------|----------|-------------|
| `kernel_*` | HOT PATH | Performance-critical parallel bootstrap code |
| `api_*` | INTERFACE | Public Rcpp exports for R users |
| `util_*` | UTILITY | Helper functions (ARCH/GARCH, Gegenbauer, etc.) |
| `test_*` | TEST ONLY | Development/validation code (deprecated) |

## Performance-Critical Code (Hot Path)

These files are called millions of times during `wbg_boot_fast()` bootstrap.
Every microsecond matters. Zero allocations in inner loops.

| File | Purpose | Key Functions |
|------|---------|---------------|
| `kernel_wbg_boot.cpp` | TBB parallel kernel | `wbg_bootstrap_kernel_cpp()` |
| `kernel_co_tstat.cpp` | Thread-safe CO t-stat | `co_tstat_ws()`, `co_tstat_fused()` |
| `kernel_burg_aic.cpp` | Thread-safe Burg algorithm | `burg_aic_select_ws()` |
| `kernel_gen_ar.cpp` | Thread-safe AR generation | `gen_ar_into()` |
| `kernel_types.h` | Workspace structs | `CoBootstrapWorkspace` |

### Key Optimization: O(1) Time-Transform

The CO t-statistic uses an optimized time-transform in `co_tstat_fused()`:

```cpp
// Instead of O(p) per observation:
// for (j = 0; j < p; ++j) t_val -= phi[j] * (t - j);

// We use O(1) via precomputed affine coefficients:
double phi_at_1 = 1.0 - sum(phi);       // phi(1)
double time_const = sum(j * phi[j]);     // C
double t_val = phi_at_1 * t + time_const;  // O(1)!
```

## Interface Layer (R-Facing)

Public Rcpp exports. May allocate memory, not for tight loops.

| File | Purpose | Key Functions |
|------|---------|---------------|
| `api_co_tstat.cpp` | CO t-statistic | `co_tstat_cpp()`, `co_full_cpp()` |
| `api_burg_aic.cpp` | Burg with AIC | `burg_aic_select_cpp()` |
| `api_ols_detrend.cpp` | OLS detrending | `ols_detrend_cpp()` |
| `api_ar_transform.cpp` | AR transformation | `ar_transform_cpp()` |
| `api_backcast.cpp` | ARMA backcasting | `backcast_cpp()` |
| `api_burg_fit.cpp` | Fixed-order Burg | `burg_fit_cpp()` (deprecated) |

## Utility Functions

Not on the hot path, used for other package features.

| File | Purpose | Key Functions |
|------|---------|---------------|
| `util_gen_arch.cpp` | ARCH generation | `gen_arch_cpp()` |
| `util_gen_garch.cpp` | GARCH generation | `gen_garch_cpp()` |
| `util_sen_slope.cpp` | Sen's slope | `sen_slope_cpp()` |
| `util_gegenb.cpp` | Gegenbauer coefficients | `gegenb_cpp()` |
| `util_convolve.cpp` | Polynomial convolution | `convolve_truncated_cpp()` |

## Call Graph

```
wbg_boot_fast.R
  |
  v
wbg_bootstrap_kernel_cpp()           [kernel_wbg_boot.cpp]
  |
  +-- WBGBootstrapWorker::operator() (TBB parallel)
        |
        +-- gen_ar_into()            [kernel_gen_ar.cpp]
        |     (generates AR series into workspace buffer)
        |
        +-- co_tstat_ws()            [kernel_co_tstat.cpp]
              |
              +-- ols_detrend_ws()   (detrend in-place)
              |
              +-- burg_aic_select_ws()  [kernel_burg_aic.cpp]
              |     (AR model selection using workspace)
              |
              +-- co_tstat_fused()   [kernel_co_tstat.cpp]
                    (O(1) time-transform + OLS in single pass)
```

## Thread Safety

### Thread-Safe (use in parallel):
- All `kernel_*` internal functions
- `gen_ar_seeded_cpp()`, `gen_ar_cpp()`
- `ols_detrend_cpp()`, `ar_transform_cpp()`

### NOT Thread-Safe (avoid in parallel):
- Functions returning `Rcpp::List`
- `gen_arch_cpp()`, `gen_garch_cpp()` (use R's RNG)

## Workspace Reuse Pattern

The `CoBootstrapWorkspace` struct pre-allocates all buffers once per thread:

```cpp
struct CoBootstrapWorkspace {
    arma::vec x_buf;    // AR series buffer
    arma::vec resid;    // Detrended residuals
    arma::vec xc;       // Centered series (Burg)
    arma::vec ef, eb;   // Forward/backward errors (Burg)
    arma::vec a_curr, a_prev;  // AR coefficients (Burg)

    void resize(int n, int maxp);
};
```

Each TBB worker chunk reuses its workspace across all iterations,
eliminating malloc/free overhead in the inner loop.

## Deprecated Functions

Functions marked with `[[deprecated]]` will emit compiler warnings.
See header comments in each file for deprecation reasons and alternatives.

## Auto-Generated Files

Do NOT edit manually:
- `RcppExports.cpp` - Generated by `Rcpp::compileAttributes()`
- `tstse-package.cpp` - Package initialization
